<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ISCC Student Portal</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    background:
        linear-gradient(rgba(79,70,229,.85), rgba(79,70,229,.85)),
        url('logoiscc.png') no-repeat center center fixed;
    background-size: cover;
}

.app-wrapper {
    max-width: 1000px;
    margin: auto;
    padding: 15px;
}

.card {
    border: none;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    background: rgba(255,255,255,.96);
}

.table thead {
    background: #4f46e5;
    color: white;
}

.profile-preview {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid #4f46e5;
}

.editing-row {
    background-color: #eef2ff !important;
    border-left: 5px solid #4f46e5;
}

.app-title {
    text-align: center;
    color: white;
    font-weight: 600;
    margin-bottom: 15px;
}

/* ===== Minor Highlight ===== */
.minor-row {
    background-color: #ffe4e6 !important;
    border-left: 5px solid #dc2626;
}
</style>
</head>

<body>

<div class="app-wrapper">
<h4 class="app-title">ISCC Student Portal</h4>

<div class="row g-3">

<!-- FORM -->
<div class="col-12 col-md-4">
<div class="card p-4">
<h5 class="fw-bold mb-3" id="formTitle">Register Student</h5>

<form id="studentForm">
<input type="hidden" id="editIndex" value="-1">

<input type="text" id="idNum" class="form-control bg-light mb-2" placeholder="Auto ID" readonly>

<div id="currentPhotoContainer" class="text-center mb-2 d-none">
<img id="formPhotoPreview" class="profile-preview">
</div>

<input type="file" id="studentPhoto" class="form-control mb-2" accept="image/*">

<input type="text" id="lastName" class="form-control mb-2" placeholder="Last Name" required>
<input type="text" id="firstName" class="form-control mb-2" placeholder="First Name" required>
<input type="text" id="middleName" class="form-control mb-2" placeholder="Middle Name">

<label class="small fw-bold">Birthdate</label>
<input type="date" id="birthdate" class="form-control mb-2" required>

<div class="row mb-3">
<div class="col-7">
<select id="course" class="form-select" required>
<option disabled selected>Course</option>
<option>BSCS</option>
<option>BSIT</option>
<option>BSCPE</option>
</select>
</div>
<div class="col-5">
<input type="number" id="yearLevel" class="form-control" placeholder="Year" min="1" max="5" required>
</div>
</div>

<button type="submit" class="btn btn-primary w-100 fw-bold" id="submitBtn">Save Student</button>
<button type="button" onclick="resetForm()" class="btn btn-link w-100 mt-2">Clear</button>
</form>
</div>
</div>

<!-- TABLE -->
<div class="col-12 col-md-8">

<input type="text" id="searchInput" class="form-control mb-3 p-3"
placeholder="ðŸ” Search name or course..." onkeyup="renderTable()">

<div class="card overflow-hidden">
<div class="table-responsive">
<table class="table table-hover mb-0">
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Age</th>
<th>Course</th>
<th class="text-center">Actions</th>
</tr>
</thead>
<tbody id="studentTableBody"></tbody>
</table>
</div>
</div>
</div>

</div>
</div>

<!-- VIEW MODAL -->
<div class="modal fade" id="viewModal" tabindex="-1">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content border-0">
<div class="modal-body text-center p-4" id="viewDetails"></div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// =======================
// DATA
// =======================
let students = JSON.parse(localStorage.getItem("students")) || [];
const viewModal = new bootstrap.Modal(document.getElementById('viewModal'));

// AGE
const calculateAge = dob =>
    Math.abs(new Date(Date.now() - new Date(dob)).getUTCFullYear() - 1970);

// IMAGE â†’ BASE64
const getBase64 = file => new Promise(res => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.readAsDataURL(file);
});

// SAVE
const saveData = () =>
    localStorage.setItem("students", JSON.stringify(students));

// SUBMIT
studentForm.addEventListener("submit", async e => {
    e.preventDefault();

    const edit = editIndex.value;
    const age = calculateAge(birthdate.value);

    // Optional: Comment out to allow minors but still highlight
    // if (age < 18) return alert("Student must be 18+");

    const dup = students.some((s,i)=>
        i!=edit &&
        s.firstName.toLowerCase()==firstName.value.toLowerCase() &&
        s.lastName.toLowerCase()==lastName.value.toLowerCase()
    );
    if (dup) return alert("Duplicate record");

    let photo = "";
    if (studentPhoto.files[0]) photo = await getBase64(studentPhoto.files[0]);
    else if (edit!=-1) photo = students[edit].photo;

    const student = {
        id: idNum.value || "STU-"+Math.floor(1000+Math.random()*9000),
        firstName: firstName.value,
        lastName: lastName.value,
        middleName: middleName.value,
        birthdate: birthdate.value,
        course: course.value,
        yearLevel: yearLevel.value,
        photo
    };

    edit==-1 ? students.push(student) : students[edit]=student;
    saveData(); resetForm();
});

// RENDER
function renderTable(){
    studentTableBody.innerHTML="";
    const q = searchInput.value.toLowerCase();

    students
    .sort((a,b)=>a.lastName.localeCompare(b.lastName))
    .filter(s=>`${s.firstName}${s.lastName}${s.course}`.toLowerCase().includes(q))
    .forEach((s,i)=>{
        const age = calculateAge(s.birthdate);
        const isMinor = age < 18 ? "minor-row" : "";

        studentTableBody.innerHTML+=`
        <tr class="${isMinor}">
            <td>${s.id}</td>
            <td>${s.lastName}, ${s.firstName}</td>
            <td>${age}</td>
            <td>${s.course}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-primary" onclick="viewStudent(${i})">View</button>
                <button class="btn btn-sm btn-warning" onclick="editStudent(${i})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteStudent(${i})">Del</button>
            </td>
        </tr>`;
    });
}

// VIEW
function viewStudent(i){
    const s=students[i];
    viewDetails.innerHTML=`
        ${s.photo?`<img src="${s.photo}" class="profile-preview mb-2">`:"ðŸ‘¤"}
        <h5>${s.firstName} ${s.lastName}</h5>
        <p>${s.course} - Year ${s.yearLevel}</p>
        <p>Birthdate: ${s.birthdate}</p>
        <p>Age: ${calculateAge(s.birthdate)}</p>`;
    viewModal.show();
}

// EDIT
function editStudent(i){
    const s=students[i];
    editIndex.value=i;
    idNum.value=s.id;
    lastName.value=s.lastName;
    firstName.value=s.firstName;
    middleName.value=s.middleName;
    birthdate.value=s.birthdate;
    course.value=s.course;
    yearLevel.value=s.yearLevel;

    if(s.photo){
        currentPhotoContainer.classList.remove("d-none");
        formPhotoPreview.src=s.photo;
    }

    formTitle.innerText="Update Student";
    submitBtn.innerText="Update Student";
    submitBtn.className="btn btn-success w-100 fw-bold";
}

// DELETE
function deleteStudent(i){
    if(confirm("Delete this student?")){
        students.splice(i,1);
        saveData(); renderTable();
    }
}

// RESET
function resetForm(){
    studentForm.reset();
    editIndex.value="-1";
    idNum.value="";
    formTitle.innerText="Register Student";
    submitBtn.innerText="Save Student";
    submitBtn.className="btn btn-primary w-100 fw-bold";
    currentPhotoContainer.classList.add("d-none");
    renderTable();
}

renderTable();
</script>

</body>
</html>
